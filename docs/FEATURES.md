# 功能特性文档

## 核心功能

### 1. 双模式观测系统

#### 实时模式（本地模式）
- 自动获取用户 GPS 位置
- 使用当前系统时间
- 每秒自动更新天体位置
- 实时天象检测

#### 指定模式
- 手动输入经纬度坐标
- 自定义日期和时间
- 支持历史天象查询（过去）
- 支持未来天象预测（未来）

### 2. 双视角可视化

#### 太阳系视角
- 俯瞰黄道面的 3D 视图
- 显示太阳、八大行星、月球
- 真实轨道椭圆（基于开普勒轨道参数）
- 实时位置更新
- 支持鼠标/触摸交互（旋转、缩放）

#### 天空视角
- 以观测者为中心的天球投影
- 显示可见行星和恒星
- 100 颗亮星背景（视星等 < 3.0）
- 黄道线标注
- 地平线和方位标识

### 3. 天文精度特性

#### 行星自转系统
- **正确的自转轴倾角**：
  - 地球：23.44°（四季成因）
  - 火星：25.19°（与地球相似）
  - 天王星：97.77°（几乎"躺着"自转）
  - 土星：26.73°

- **绕倾斜轴自转**：
  - 使用四元数（Quaternion）实现
  - 自转绕局部 Y 轴（倾斜后的轴）
  - 避免欧拉角的万向锁问题

- **动态自转速度**：
  - 快速行星（木星 9.93h）：60x 加速
  - 中速行星（地球 23.93h）：60x 加速
  - 慢速行星（水星 1407.6h）：600x 加速
  - 极慢行星（金星 5832.5h）：600x 加速

#### 月球潮汐锁定
- 月球始终以同一面朝向地球
- 纹理贴图正确对齐（月面/月背）
- 保持 6.68° 的轴倾角
- 白道倾角 5.14°（相对黄道）

#### 土星光环
- 光环倾角与土星轴倾角一致（26.73°）
- 光环在土星赤道平面上
- 径向纹理映射（内圈到外圈）
- 可调透明度（真实模式 opacity: 0.95）

### 4. 渲染模式

#### 纯色模式
- 使用配置的行星颜色
- 高饱和度、明亮
- 适合快速识别
- 性能最优

#### 真实模式（纹理模式）
- 使用真实行星纹理贴图
- 支持本地纹理加载
- 程序化纹理作为后备
- 色彩增强（70% 配置色 + 30% 白色）
- Tone Mapping 防止过曝

### 5. 天象检测系统

#### 日食检测
- **检测条件**：
  - 太阳和月球角距离 < 2°
  - 月相在新月附近（黄经差 < 15°）

- **精确搜索**：
  - 使用 Astronomy Engine 的 `SearchGlobalSolarEclipse` API
  - 搜索当前时间 ±7 天内的日食
  - 识别日食类型：日全食、日环食、日偏食

- **显示信息**：
  - 日食类型（中文）
  - 食甚时间
  - 涉及天体（太阳、月球）

#### 月食检测
- **检测条件**：
  - 月相在满月附近（黄经差接近 180°）
  - 月球接近黄道面（黄纬 < 2°）

- **精确搜索**：
  - 使用 Astronomy Engine 的 `SearchLunarEclipse` API
  - 搜索当前时间 ±7 天内的月食
  - 识别月食类型：月全食、月偏食、半影月食

- **显示信息**：
  - 月食类型（中文）
  - 食甚时间
  - 涉及天体（月球、地球）

#### 其他天象
- **行星冲日**：外行星与太阳角距离 170°-190°
- **行星合日**：行星与太阳角距离 < 10°
- **行星连珠**：≥3 颗行星黄经差 < 45°

### 6. 交互功能

#### 天体选择
- 点击行星查看详细信息
- 显示内容：
  - 中文名称
  - 赤经/赤纬（地心赤道坐标）
  - 高度角/方位角（地平坐标）
  - 距离（AU）
  - 视星等
  - 所在星座

#### 视角控制
- **太阳系视角**：
  - 鼠标左键拖拽：旋转
  - 滚轮：缩放
  - 初始俯视黄道面

- **天空视角**：
  - 鼠标拖拽：旋转天球
  - 双指捏合（移动端）：缩放
  - 拖拽方向与天空移动一致

#### 时间控制
- 实时模式：自动更新
- 指定模式：日期时间选择器
- 支持任意历史/未来时间

### 7. 移动端优化

#### 响应式布局
- 桌面端：侧边栏控制面板
- 移动端：底部抽屉式面板
- 自适应断点：768px

#### 触摸手势
- 单指拖拽：旋转视角
- 双指捏合：缩放
- 点击：选择天体

#### 性能优化
- 自适应像素比（最大 2x）
- 关闭阴影映射（提高性能）
- 优化纹理分辨率

## 技术实现

### 天文计算
- **库**：astronomy-engine
- **精度**：< 1 角分
- **算法**：VSOP87（行星位置）
- **坐标系**：
  - 地心赤道坐标（RA/Dec）
  - 地平坐标（Alt/Az）
  - 日心黄道坐标（Helio Lon/Lat）
  - 地心黄道坐标（月球）

### 3D 渲染
- **库**：Three.js
- **渲染器**：WebGLRenderer
- **Tone Mapping**：ACESFilmicToneMapping
- **曝光控制**：toneMappingExposure = 1.5
- **材质**：MeshStandardMaterial（支持光照和纹理）

### 坐标变换
- 黄道坐标 → 3D 场景坐标
- 对数缩放（AU → 场景单位）
- 椭圆轨道参数化
- 球面坐标 → 笛卡尔坐标

### 纹理管理
- 异步加载纹理
- 程序化纹理后备
- 纹理缓存（避免重复加载）
- 模式切换时保留纹理引用

## 数据来源

### 行星数据
- 轨道参数：半长轴、离心率、倾角
- 物理参数：半径、质量、自转周期
- 轴倾角：相对黄道面
- 纹理：本地 JPG/PNG 文件

### 星表数据
- 来源：HYG Database
- 筛选：视星等 < 3.0（100 颗亮星）
- 数据：赤经、赤纬、视星等、颜色指数
- 格式：JSON

### 月球数据
- 轨道：地心黄道坐标
- 白道倾角：5.14°
- 轴倾角：6.68°
- 自转周期：27.3 天（潮汐锁定）

## 验证方法

### 位置精度验证
- 对比软件：Stellarium
- 测试时间：2026-02-21 20:00 北京
- 误差范围：< 1°

### 日月食验证
- 已知日食日期：
  - 2024-04-08：日全食（北美）
  - 2025-03-14：日全食（北大西洋）

- 已知月食日期：
  - 2024-09-18：月偏食
  - 2025-09-07：月全食

### 自转验证
- 观察地球：倾斜 23.44°，绕倾斜轴自转
- 观察天王星：几乎"躺着"（97.77°）
- 观察土星：光环与轴倾角一致
- 观察月球：始终同一面朝向地球

## 未来计划

### 功能增强
- [ ] 添加更多小行星和彗星
- [ ] 支持卫星系统（木星四大卫星等）
- [ ] 添加流星雨预测
- [ ] 支持日食/月食路径可视化

### 性能优化
- [ ] WebGL 2.0 支持
- [ ] 实例化渲染（恒星）
- [ ] LOD（细节层次）系统
- [ ] Web Worker 计算

### 用户体验
- [ ] VR/AR 支持
- [ ] 语音控制
- [ ] 分享功能（截图/链接）
- [ ] 天象提醒（通知）
