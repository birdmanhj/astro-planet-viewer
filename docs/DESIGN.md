# æŠ€æœ¯è®¾è®¡æ–‡æ¡£ (DESIGN)
# å¤©æ–‡è¡Œæ˜Ÿä½ç½®æŸ¥è¯¢å±•ç¤ºç½‘ç«™

**ç‰ˆæœ¬ï¼š** 1.0.0
**æ—¥æœŸï¼š** 2026-02-24
**æ›´æ–°ï¼š** æ·»åŠ åæ ‡ç³»ç»Ÿè¯¦ç»†è®¾è®¡å’Œå››å…ƒæ•°æ—‹è½¬å®ç°

---

## 1. æŠ€æœ¯æ¶æ„æ¦‚è§ˆ

### 1.1 æŠ€æœ¯æ ˆ

| å±‚æ¬¡ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | ç†ç”± |
|------|---------|------|------|
| å‰ç«¯æ¡†æ¶ | React | 19.x | ç»„ä»¶åŒ–ï¼ŒçŠ¶æ€ç®¡ç†ç®€æ´ |
| æ„å»ºå·¥å…· | Vite | 7.x | å¿«é€ŸHMRï¼ŒESæ¨¡å—åŸç”Ÿæ”¯æŒ |
| 3Dæ¸²æŸ“ | Three.js | 0.183+ | è¡Œä¸šæ ‡å‡†WebGLåº“ï¼Œæ–‡æ¡£å®Œå–„ |
| å¤©æ–‡è®¡ç®— | astronomy-engine | 2.1.x | é«˜ç²¾åº¦ï¼Œçº¯JSï¼Œæ— å¤–éƒ¨ä¾èµ– |
| æ˜Ÿè¡¨æ•°æ® | HYG Database | 3.x | å¼€æºï¼Œå«9000é¢—äº®æ˜Ÿï¼Œå«å…‰è°±å‹ |
| æ ·å¼ | Tailwind CSS | 4.x | å“åº”å¼æ–­ç‚¹å†…ç½®ï¼Œæ·±è‰²ä¸»é¢˜ä¾¿æ· |

### 1.2 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æµè§ˆå™¨ (Client Only)                   â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ControlPanel â”‚    â”‚         App State             â”‚   â”‚
â”‚  â”‚  - æ¨¡å¼åˆ‡æ¢   â”‚â—„â”€â”€â–ºâ”‚  - mode (local/custom)       â”‚   â”‚
â”‚  â”‚  - æ—¶é—´é€‰æ‹©   â”‚    â”‚  - time (Date)               â”‚   â”‚
â”‚  â”‚  - åœ°ç‚¹è¾“å…¥   â”‚    â”‚  - location (lat/lng)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  - activeView (solar/sky)    â”‚   â”‚
â”‚                       â”‚  - selectedBody (string)     â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”‚  InfoPanel   â”‚                  â”‚                     â”‚
â”‚  â”‚  - å¤©ä½“è¯¦æƒ…  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  useAstronomy   â”‚           â”‚
â”‚                            â”‚  (Hook)         â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  astronomy-     â”‚           â”‚
â”‚  â”‚ SolarSystem  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚  engine         â”‚           â”‚
â”‚  â”‚ View         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”‚ (Three.js)   â”‚                  â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                            â”‚  planetPositions â”‚           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  starData        â”‚           â”‚
â”‚  â”‚  SkyView     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚  (computed)      â”‚           â”‚
â”‚  â”‚  (Three.js)  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. é¡¹ç›®ç»“æ„

```
astro-planet-viewer/
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ SRD.md                    # è½¯ä»¶éœ€æ±‚æ–‡æ¡£
â”‚   â””â”€â”€ DESIGN.md                 # æœ¬æ–‡æ¡£
â”œâ”€â”€ public/
â”‚   â””â”€â”€ data/
â”‚       â”œâ”€â”€ stars_bright.json     # é¢„å¤„ç†äº®æ˜Ÿæ•°æ®ï¼ˆmag<6.5ï¼Œ~9000é¢—ï¼‰
â”‚       â””â”€â”€ constellations.json   # æ˜Ÿåº§è¿çº¿æ•°æ®ï¼ˆ88ä¸ªæ˜Ÿåº§ï¼‰
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ SolarSystemView.jsx   # å¤ªé˜³ç³»3Dä¿¯è§†åœºæ™¯
â”‚   â”‚   â”œâ”€â”€ SkyView.jsx           # å¤©ç©ºç©¹é¡¶åœºæ™¯
â”‚   â”‚   â”œâ”€â”€ ControlPanel.jsx      # æ§åˆ¶é¢æ¿ï¼ˆæ¨¡å¼/æ—¶é—´/åœ°ç‚¹ï¼‰
â”‚   â”‚   â””â”€â”€ InfoPanel.jsx         # å¤©ä½“ä¿¡æ¯å±•ç¤ºé¢æ¿
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useAstronomy.js       # å¤©æ–‡è®¡ç®—æ ¸å¿ƒHook
â”‚   â”‚   â””â”€â”€ useGeolocation.js     # æµè§ˆå™¨å®šä½Hook
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ coordinates.js        # åæ ‡å˜æ¢å·¥å…·å‡½æ•°
â”‚   â”‚   â””â”€â”€ planetConfig.js       # è¡Œæ˜Ÿé…ç½®ï¼ˆé¢œè‰²/å¤§å°/åç§°ï¼‰
â”‚   â”œâ”€â”€ App.jsx                   # æ ¹ç»„ä»¶ï¼ŒçŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ main.jsx                  # å…¥å£æ–‡ä»¶
â”‚   â””â”€â”€ index.css                 # å…¨å±€æ ·å¼ï¼ˆTailwindå¯¼å…¥ï¼‰
â”œâ”€â”€ package.json
â””â”€â”€ vite.config.js
```

---

## 3. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 3.1 å¤©æ–‡è®¡ç®—æ¨¡å— (`useAstronomy.js`)

**èŒè´£ï¼š** å°è£… astronomy-engineï¼Œæä¾›è¡Œæ˜Ÿä½ç½®æ•°æ®

**è¾“å…¥ï¼š**
- `time`: Date å¯¹è±¡
- `observer`: `{ latitude, longitude, elevation }`

**è¾“å‡ºï¼š**
```javascript
{
  planets: [
    {
      name: 'Mars',           // è‹±æ–‡å
      nameZh: 'ç«æ˜Ÿ',          // ä¸­æ–‡å
      // æ—¥å¿ƒé»„é“åæ ‡ï¼ˆå¤ªé˜³ç³»è§†å›¾ç”¨ï¼‰
      helioLon: 123.45,       // é»„ç»ï¼ˆåº¦ï¼‰
      helioLat: 1.23,         // é»„çº¬ï¼ˆåº¦ï¼‰
      helioDistAU: 1.52,      // è·å¤ªé˜³ï¼ˆAUï¼‰
      // åœ°å¿ƒèµ¤é“åæ ‡
      ra: 12.34,              // èµ¤ç»ï¼ˆå°æ—¶ï¼‰
      dec: -5.67,             // èµ¤çº¬ï¼ˆåº¦ï¼‰
      // åœ°å¹³åæ ‡ï¼ˆå¤©ç©ºè§†å›¾ç”¨ï¼‰
      altitude: 45.0,         // é«˜åº¦è§’ï¼ˆåº¦ï¼‰
      azimuth: 180.0,         // æ–¹ä½è§’ï¼ˆåº¦ï¼ŒåŒ—=0ï¼‰
      // å…¶ä»–ä¿¡æ¯
      distanceAU: 0.89,       // è·åœ°çƒï¼ˆAUï¼‰
      magnitude: -1.5,        // è§†æ˜Ÿç­‰
      constellation: 'Orion', // æ‰€åœ¨æ˜Ÿåº§
    }
  ],
  sun: { ... },               // å¤ªé˜³æ•°æ®ï¼ˆåŒæ ¼å¼ï¼‰
  moon: { ... },              // æœˆçƒæ•°æ®
  phenomena: [                // ç‰¹æ®Šå¤©è±¡
    { type: 'conjunction', bodies: ['Jupiter', 'Saturn'], description: 'æœ¨åœŸå¤§åˆ' }
  ]
}
```

**å…³é”® API è°ƒç”¨ï¼š**
```javascript
import * as Astronomy from 'astronomy-engine';

// åˆ›å»ºè§‚æµ‹è€…
const observer = new Astronomy.Observer(lat, lng, elevation);
const time = new Astronomy.AstroTime(date);

// è·å–è¡Œæ˜Ÿåœ°å¿ƒèµ¤é“åæ ‡
const equatorial = Astronomy.Equator('Mars', time, observer, true, true);

// è½¬æ¢ä¸ºåœ°å¹³åæ ‡
const horizontal = Astronomy.Horizon(time, observer, equatorial.ra, equatorial.dec, 'normal');

// è·å–æ—¥å¿ƒé»„é“åæ ‡ï¼ˆå¤ªé˜³ç³»è§†å›¾ï¼‰
const ecliptic = Astronomy.EclipticGeoMoon(time); // æœˆçƒ
// å¯¹äºè¡Œæ˜Ÿï¼Œä½¿ç”¨ HelioVector ç„¶åè½¬æ¢
const helioVec = Astronomy.HelioVector('Mars', time);
```

---

### 3.2 åæ ‡å˜æ¢å·¥å…· (`coordinates.js`)

**å‡½æ•°åˆ—è¡¨ï¼š**

```javascript
// åœ°å¹³åæ ‡ â†’ Three.js 3Dåæ ‡ï¼ˆå¤©ç©ºè§†å›¾ï¼‰
// å¤©çƒåŠå¾„ R=1000ï¼Œç›¸æœºåœ¨çƒå¿ƒ
// åæ ‡ç³»ï¼šYè½´å‘ä¸Šï¼ŒXè½´å‘ä¸œï¼Œ-Zè½´å‘å—ï¼ˆåŒ—æ–¹å‘ä¸º+Zï¼‰
altAzToVector3(altitude, azimuth, radius = 1000)

// èµ¤é“åæ ‡ â†’ åœ°å¹³åæ ‡ï¼ˆçƒé¢ä¸‰è§’å­¦ï¼‰
// åŒ…å«æç‚¹å¥‡å¼‚æ€§å¤„ç†
raDecToAltAz(raDeg, decDeg, latDeg, lstDeg)

// èµ¤é“åæ ‡ â†’ Three.js 3Dåæ ‡ï¼ˆé€šè¿‡ Alt/Az ä¸­é—´è½¬æ¢ï¼‰
// ä½¿ç”¨å·²éªŒè¯çš„è½¬æ¢ç®¡é“ï¼Œç¡®ä¿ä¸€è‡´æ€§
raDecToVector3(raDeg, decDeg, latDeg, lstDeg, radius = 1000)

// è®¡ç®—æœ¬åœ°æ’æ˜Ÿæ—¶ï¼ˆåº¦ï¼‰
getLocalSiderealTime(date, lngDeg)

// é»„é“åæ ‡ â†’ Three.js 3Dåæ ‡ï¼ˆå¤ªé˜³ç³»è§†å›¾ï¼‰
// å¯¹æ•°ç¼©æ”¾è½¨é“åŠå¾„
eclipticToVector3(lon, lat, distAU)

// AU â†’ åœºæ™¯å•ä½ï¼ˆå¯¹æ•°ç¼©æ”¾ï¼‰
auToScene(au)  // log(au * 10 + 1) * 30
```

**æç‚¹å¥‡å¼‚æ€§å¤„ç†ï¼š**

å½“å¤©ä½“æ¥è¿‘å¤©é¡¶æˆ–å¤©åº•æ—¶ï¼ˆ`cos(Alt) â‰ˆ 0`ï¼‰ï¼Œæ–¹ä½è§’è®¡ç®—åˆ†æ¯è¶‹è¿‘äºé›¶ã€‚è§£å†³æ–¹æ¡ˆï¼š

```javascript
const denom = Math.cos(altitude * DEG2RAD) * Math.cos(latRad);
if (Math.abs(denom) < 1e-10) {
  // æç‚¹é™„è¿‘ï¼Œæ–¹ä½è§’ç”±æ—¶è§’å†³å®š
  // åŒ—å¤©æï¼šazimuth = 180Â° - HAï¼ˆä»å—æ–¹çœ‹å‘åŒ—æï¼‰
  // å—å¤©æï¼šazimuth = HAï¼ˆä»åŒ—æ–¹çœ‹å‘å—æï¼‰
  const azimuth = altitude > 0 ? (180 - ha + 360) % 360 : ha;
  return { altitude, azimuth };
}
```

è¿™ç¡®ä¿äº†æ‰€æœ‰èµ¤ç»çº¿åœ¨æç‚¹é™„è¿‘å‡åŒ€åˆ†å¸ƒï¼Œé¿å…é‡å æˆ–è®¡ç®—é”™è¯¯ã€‚

---

### 3.3 è¡Œæ˜Ÿé…ç½® (`planetConfig.js`)

```javascript
export const PLANETS = [
  {
    id: 'Sun',
    nameZh: 'å¤ªé˜³',
    color: 0xFDB813,
    radius: 8,          // åœºæ™¯ä¸­æ˜¾ç¤ºåŠå¾„ï¼ˆå¯¹æ•°ç¼©æ”¾ï¼‰
    orbitColor: 0x444400,
    textureUrl: null,   // æš‚ç”¨çº¯è‰²
  },
  {
    id: 'Mercury', nameZh: 'æ°´æ˜Ÿ',
    color: 0xB5B5B5, radius: 1.5, orbitColor: 0x555555,
    orbitalPeriodDays: 87.97,
  },
  // ... å…¶ä»–è¡Œæ˜Ÿ
  {
    id: 'Saturn', nameZh: 'åœŸæ˜Ÿ',
    color: 0xC2A45A, radius: 5, orbitColor: 0x554422,
    hasRings: true,     // ç‰¹æ®Šå¤„ç†ï¼šæ·»åŠ å…‰ç¯
    orbitalPeriodDays: 10759.22,
  },
];
```

---

### 3.4 å¤ªé˜³ç³»3Dè§†å›¾ (`SolarSystemView.jsx`)

**Three.js åœºæ™¯æ„æˆï¼š**

```
Scene
â”œâ”€â”€ AmbientLight (å¼±ç¯å¢ƒå…‰)
â”œâ”€â”€ PointLight (å¤ªé˜³ä½ç½®ï¼Œæ¨¡æ‹Ÿæ—¥å…‰)
â”œâ”€â”€ Sun (Mesh: SphereGeometry + å‘å…‰æè´¨)
â”œâ”€â”€ PlanetGroup[8]
â”‚   â”œâ”€â”€ OrbitLine (Line: EllipseCurve)
â”‚   â”œâ”€â”€ PlanetMesh (Mesh: SphereGeometry)
â”‚   â””â”€â”€ Label (Sprite: Canvasçº¹ç†)
â”œâ”€â”€ StarField (Points: èƒŒæ™¯æ˜Ÿç‚¹ï¼Œå›ºå®šä½ç½®)
â””â”€â”€ Camera (PerspectiveCamera)
    â””â”€â”€ OrbitControls (é¼ æ ‡/è§¦æ‘¸æ§åˆ¶)
```

**è½¨é“åŠå¾„ç¼©æ”¾ç­–ç•¥ï¼š**
```javascript
// çœŸå®AU â†’ åœºæ™¯å•ä½ï¼ˆå¯¹æ•°ç¼©æ”¾ï¼Œé¿å…å†…å¤–è¡Œæ˜Ÿæ¯”ä¾‹æ‚¬æ®Šï¼‰
function auToScene(au) {
  return Math.log(au * 10 + 1) * 30;
}
// æ°´æ˜Ÿ(0.39AU) â†’ ~11å•ä½
// åœ°çƒ(1.0AU)  â†’ ~20å•ä½
// æµ·ç‹æ˜Ÿ(30AU) â†’ ~80å•ä½
```

**è¡Œæ˜Ÿä½ç½®æ›´æ–°ï¼š**
```javascript
// æ¯æ¬¡æ—¶é—´å˜åŒ–æ—¶æ›´æ–°
function updatePlanetPositions(planetData) {
  planetData.forEach(planet => {
    const { helioLon, helioLat, helioDistAU } = planet;
    const pos = eclipticToVector3(helioLon, helioLat, helioDistAU);
    planetMeshes[planet.name].position.copy(pos);
  });
}
```

---

### 3.5 å¤©ç©ºç©¹é¡¶è§†å›¾ (`SkyView.jsx`)

**Three.js åœºæ™¯æ„æˆï¼š**

```
Scene
â”œâ”€â”€ SkyDome (Mesh: SphereGeometry, BackSide, æ¸å˜å¤©ç©ºè‰²)
â”œâ”€â”€ HorizonPlane (Mesh: åŠé€æ˜åœ°é¢)
â”œâ”€â”€ StarField (Points: HYGæ˜Ÿè¡¨æ•°æ®)
â”‚   â””â”€â”€ æŒ‰æ˜Ÿç­‰è®¾ç½®ç‚¹å¤§å°å’Œé€æ˜åº¦
â”œâ”€â”€ ConstellationLines (LineSegments: æ˜Ÿåº§è¿çº¿)
â”œâ”€â”€ EclipticLine (Line: é»„é“åœ†)
â”œâ”€â”€ CelestialGrid (èµ¤ç»èµ¤çº¬ç½‘æ ¼)
â”‚   â”œâ”€â”€ DeclinationCircles (5æ¡: -60Â°, -30Â°, 0Â°, +30Â°, +60Â°)
â”‚   â””â”€â”€ RALines (12æ¡ Ã— 2æ®µï¼Œåˆ†æ®µç»˜åˆ¶é¿å…è§†é”¥ä½“è£å‰ª)
â”œâ”€â”€ PlanetMarkers[9] (Sprite: è¡Œæ˜Ÿæ ‡è®°)
â”‚   â””â”€â”€ å¸¦åç§°æ ‡ç­¾
â”œâ”€â”€ CompassLabels (Sprite: ä¸œå—è¥¿åŒ—æ ‡æ³¨)
â””â”€â”€ Camera (PerspectiveCamera, FOV=75)
    â””â”€â”€ å››å…ƒæ•°æ—‹è½¬æ§åˆ¶ï¼ˆè½¨è¿¹çƒç®—æ³•ï¼‰
```

**åæ ‡è½¬æ¢ï¼ˆAlt/Az â†’ 3Dï¼‰ï¼š**
```javascript
function altAzToVector3(altDeg, azDeg, r = 1000) {
  const alt = altDeg * Math.PI / 180;
  const az = azDeg * Math.PI / 180;
  // æ³¨æ„ï¼šThree.js Yè½´å‘ä¸Šï¼ŒZè½´å‘åŒ—
  return new THREE.Vector3(
    r * Math.cos(alt) * Math.sin(az),   // x: ä¸œ
    r * Math.sin(alt),                   // y: ä¸Š
    -r * Math.cos(alt) * Math.cos(az)   // z: å—ï¼ˆè´ŸZå‘å—ï¼‰
  );
}
```

**èµ¤ç»çº¿åˆ†æ®µæ¸²æŸ“ï¼š**

ä¸ºé¿å… Three.js è§†é”¥ä½“è£å‰ªé—®é¢˜ï¼Œæ¯æ¡èµ¤ç»çº¿åˆ†æˆä¸¤æ®µç»˜åˆ¶ï¼š

```javascript
// å—åŠçƒæ®µï¼š-90Â° åˆ° 0Â°
for (let i = 0; i <= 18; i++) {
  const decDeg = -90 + (i / 18) * 90;
  ptsSouth.push(raDecToVector3(raDeg, decDeg, lat, lst, R));
}

// åŒ—åŠçƒæ®µï¼š0Â° åˆ° +90Â°
for (let i = 0; i <= 18; i++) {
  const decDeg = (i / 18) * 90;
  ptsNorth.push(raDecToVector3(raDeg, decDeg, lat, lst, R));
}
```

è¿™ç¡®ä¿å³ä½¿ä¸€ä¸ªæç‚¹åœ¨è§†é‡å¤–ï¼Œå¦ä¸€æ®µä»èƒ½æ­£å¸¸æ¸²æŸ“ã€‚

**è½¨è¿¹çƒæ—‹è½¬ç®—æ³•ï¼š**

ä½¿ç”¨å››å…ƒæ•°å®ç°æ— ä¸‡å‘é”çš„å¹³æ»‘æ—‹è½¬ï¼š

```javascript
function rotateSky(dx, dy, factor) {
  // 1. è®¡ç®—æ—‹è½¬è½´ï¼ˆå‚ç›´äºé¼ æ ‡ç§»åŠ¨æ–¹å‘ï¼‰
  const rotationAxis = new THREE.Vector3(dy, dx, 0).normalize();

  // 2. è½¬æ¢åˆ°ä¸–ç•Œç©ºé—´
  rotationAxis.applyQuaternion(orientationRef.current);

  // 3. è®¡ç®—æ—‹è½¬è§’åº¦
  const angle = Math.sqrt(dx * dx + dy * dy) * factor;

  // 4. åˆ›å»ºæ—‹è½¬å››å…ƒæ•°
  const rotationQ = new THREE.Quaternion().setFromAxisAngle(rotationAxis, angle);

  // 5. åº”ç”¨æ—‹è½¬
  orientationRef.current.premultiply(rotationQ);
  camera.quaternion.copy(orientationRef.current);
}
```

**æ’æ˜Ÿæ¸²æŸ“ï¼š**
```javascript
// ä» stars_bright.json åŠ è½½ï¼Œè½¬æ¢ä¸º BufferGeometry
const positions = new Float32Array(stars.length * 3);
const sizes = new Float32Array(stars.length);
const colors = new Float32Array(stars.length * 3);

stars.forEach((star, i) => {
  // RA/Dec â†’ Alt/Azï¼ˆéœ€è¦è§‚æµ‹è€…ä½ç½®å’Œæ—¶é—´ï¼‰
  const { altitude, azimuth } = raDecToAltAz(star.ra * 15, star.dec, lat, lst);
  const pos = altAzToVector3(altitude, azimuth, 1000);
  positions[i*3] = pos.x; positions[i*3+1] = pos.y; positions[i*3+2] = pos.z;

  // æ˜Ÿç­‰ â†’ å¤§å°ï¼ˆmag 1 = å¤§ï¼Œmag 6 = å°ï¼‰
  sizes[i] = Math.max(0.5, (7 - star.mag) * 0.8);

  // B-Vè‰²æŒ‡æ•° â†’ RGBé¢œè‰²
  const rgb = bvToRgb(star.bv);
  colors[i*3] = rgb.r; colors[i*3+1] = rgb.g; colors[i*3+2] = rgb.b;
});
```

---

### 3.6 æ§åˆ¶é¢æ¿ (`ControlPanel.jsx`)

**æ¡Œé¢ç«¯å¸ƒå±€ï¼ˆä¾§è¾¹æ ï¼‰ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŒŒ å¤©æ–‡è§‚æµ‹å°        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·¥ä½œæ¨¡å¼              â”‚
â”‚ [æœ¬åœ°æ¨¡å¼] [æŒ‡å®šæ¨¡å¼] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è§‚æµ‹ä½ç½®              â”‚
â”‚ ğŸ“ åŒ—äº¬ (39.9Â°N)    â”‚
â”‚ [æ›´æ”¹ä½ç½®]           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è§‚æµ‹æ—¶é—´              â”‚
â”‚ [2026-02-21 20:00] â”‚
â”‚ [â—„â—„] [â—„] [â–º] [â–ºâ–º] â”‚
â”‚ æ­¥é•¿: [1h][1d][1m]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è§†è§’                  â”‚
â”‚ [å¤ªé˜³ç³»] [å¤©ç©º]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å½“å‰å¤©è±¡              â”‚
â”‚ âœ¨ æœ¨æ˜Ÿå†²æ—¥           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç§»åŠ¨ç«¯å¸ƒå±€ï¼ˆåº•éƒ¨æŠ½å±‰ï¼‰ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [å¤ªé˜³ç³»] [å¤©ç©º]  ğŸ“åŒ—äº¬ âš™ï¸  â”‚  â† é¡¶éƒ¨å·¥å…·æ 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              â”‚
â”‚      Three.js æ¸²æŸ“åŒºåŸŸ        â”‚
â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â–² æ§åˆ¶é¢æ¿ï¼ˆä¸Šæ»‘å±•å¼€ï¼‰       â”‚  â† åº•éƒ¨æŠ½å±‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3.7 çŠ¶æ€ç®¡ç† (`App.jsx`)

ä½¿ç”¨ React `useState` + `useReducer` ç®¡ç†å…¨å±€çŠ¶æ€ï¼š

```javascript
const initialState = {
  mode: 'local',              // 'local' | 'custom'
  time: new Date(),           // å½“å‰è§‚æµ‹æ—¶é—´
  location: {
    latitude: 39.9,           // é»˜è®¤åŒ—äº¬
    longitude: 116.4,
    elevation: 50,
    name: 'åŒ—äº¬',
  },
  activeView: 'solar',        // 'solar' | 'sky'
  selectedBody: null,         // é€‰ä¸­çš„å¤©ä½“åç§°
  isControlPanelOpen: false,  // ç§»åŠ¨ç«¯æŠ½å±‰çŠ¶æ€
};
```

---

## 4. æ•°æ®æ–‡ä»¶è®¾è®¡

### 4.1 `stars_bright.json`

ç”± HYG Database CSV é¢„å¤„ç†ç”Ÿæˆï¼Œåªä¿ç•™å¿…è¦å­—æ®µï¼š

```json
[
  {
    "id": 9884,
    "name": "Sirius",
    "nameZh": "å¤©ç‹¼æ˜Ÿ",
    "ra": 6.7525,      // èµ¤ç»ï¼ˆå°æ—¶ï¼‰
    "dec": -16.7161,   // èµ¤çº¬ï¼ˆåº¦ï¼‰
    "mag": -1.46,      // è§†æ˜Ÿç­‰
    "bv": 0.009,       // B-Vè‰²æŒ‡æ•°ï¼ˆç”¨äºé¢œè‰²ï¼‰
    "spect": "A1V"     // å…‰è°±å‹
  }
]
```

è¿‡æ»¤æ¡ä»¶ï¼š`mag < 6.5`ï¼Œçº¦9000æ¡è®°å½•ï¼Œæ–‡ä»¶å¤§å°çº¦ 500KBã€‚

### 4.2 `constellations.json`

æ˜Ÿåº§è¿çº¿æ•°æ®ï¼ˆæ¥è‡ª d3-celestial é¡¹ç›®ï¼Œå¼€æºï¼‰ï¼š

```json
{
  "Orion": {
    "nameZh": "çŒæˆ·åº§",
    "lines": [[24436, 27989], [27989, 29426], ...]  // HYGæ˜ŸIDå¯¹
  }
}
```

---

## 5. å“åº”å¼è®¾è®¡ç­–ç•¥

### 5.1 æ–­ç‚¹å®šä¹‰ï¼ˆTailwindï¼‰

| æ–­ç‚¹ | å®½åº¦ | å¸ƒå±€ |
|------|------|------|
| é»˜è®¤ï¼ˆæ‰‹æœºï¼‰ | < 768px | å…¨å±æ¸²æŸ“ + åº•éƒ¨æŠ½å±‰ |
| mdï¼ˆå¹³æ¿ï¼‰ | 768-1024px | å…¨å±æ¸²æŸ“ + ä¾§è¾¹æ ï¼ˆå¯æŠ˜å ï¼‰ |
| lgï¼ˆæ¡Œé¢ï¼‰ | > 1024px | å·¦ä¾§è¾¹æ  + å³ä¾§æ¸²æŸ“åŒº |

### 5.2 Three.js è§¦æ‘¸æ”¯æŒ

Three.js OrbitControls å†…ç½®è§¦æ‘¸æ”¯æŒï¼Œä½†å¤©ç©ºè§†å›¾éœ€è¦è‡ªå®šä¹‰ï¼š

```javascript
// å¤©ç©ºè§†å›¾ï¼šçƒé¢æ—‹è½¬ï¼ˆä¸æ˜¯è½¨é“æ—‹è½¬ï¼‰
canvas.addEventListener('touchstart', onTouchStart, { passive: false });
canvas.addEventListener('touchmove', onTouchMove, { passive: false });

function onTouchMove(e) {
  e.preventDefault();
  if (e.touches.length === 1) {
    // å•æŒ‡ï¼šæ—‹è½¬è§†è§’
    const dx = e.touches[0].clientX - lastTouch.x;
    const dy = e.touches[0].clientY - lastTouch.y;
    rotateCamera(dx * 0.3, dy * 0.3);
  } else if (e.touches.length === 2) {
    // åŒæŒ‡ï¼šç¼©æ”¾FOV
    const dist = getTouchDistance(e.touches);
    camera.fov = clamp(camera.fov * (lastPinchDist / dist), 20, 120);
    camera.updateProjectionMatrix();
  }
}
```

---

## 6. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

1. **æ˜Ÿè¡¨æ‡’åŠ è½½**ï¼š`stars_bright.json` å¼‚æ­¥åŠ è½½ï¼ŒåŠ è½½å‰æ˜¾ç¤ºå ä½ç¬¦
2. **ç§»åŠ¨ç«¯é™çº§**ï¼šæ£€æµ‹è®¾å¤‡æ€§èƒ½ï¼Œæ‰‹æœºç«¯åªæ¸²æŸ“ mag < 5.0 çš„æ˜Ÿï¼ˆçº¦1600é¢—ï¼‰
3. **Three.js ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ `BufferGeometry` è€Œé `Geometry`
   - æ˜Ÿç‚¹ä½¿ç”¨ `THREE.Points`ï¼ˆå•æ¬¡draw callï¼‰
   - è½¨é“çº¿ä½¿ç”¨ `LineSegments`
   - èµ¤ç»çº¿åˆ†æ®µæ¸²æŸ“ï¼Œä¼˜åŒ–è§†é”¥ä½“è£å‰ª
4. **è®¡ç®—ç¼“å­˜**ï¼šæ’æ˜Ÿ Alt/Az åæ ‡æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ï¼ˆéå®æ—¶ï¼‰
5. **å››å…ƒæ•°æ—‹è½¬**ï¼šä½¿ç”¨è½¨è¿¹çƒç®—æ³•ï¼Œé¿å…ä¸‡å‘é”ï¼Œæä¾›å¹³æ»‘æ—‹è½¬ä½“éªŒ
6. **Web Worker**ï¼ˆå¯é€‰ï¼‰ï¼šå°†å¤©æ–‡è®¡ç®—ç§»è‡³ Worker çº¿ç¨‹

---

## 7. éªŒè¯ä¸æµ‹è¯•

| æµ‹è¯•é¡¹ | æ–¹æ³• | é¢„æœŸç»“æœ |
|--------|------|---------|
| è¡Œæ˜Ÿä½ç½®ç²¾åº¦ | å¯¹æ¯” Stellariumï¼ˆ2026-02-21 20:00 åŒ—äº¬ï¼‰ | è¯¯å·® < 1Â° |
| å†å²å¤©è±¡ | è¾“å…¥2020-12-21ï¼ŒéªŒè¯æœ¨åœŸå¤§åˆ | æœ¨æ˜ŸåœŸæ˜Ÿè§’è· < 0.2Â° |
| ç§»åŠ¨ç«¯è§¦æ‘¸ | iOS Safari + Android Chrome å®æµ‹ | æµç•…æ—‹è½¬ç¼©æ”¾ |
| åŠ è½½æ€§èƒ½ | Chrome DevTools Network | é¦–å± < 5sï¼ˆ4Gç½‘ç»œï¼‰ |
| ç‰¹æ®Šå¤©è±¡æ£€æµ‹ | è¾“å…¥å·²çŸ¥è¿ç æ—¥æœŸ | æ­£ç¡®æ˜¾ç¤ºæç¤º |
