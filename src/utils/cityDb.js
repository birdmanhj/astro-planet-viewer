// 全球主要城市经纬度查询表 [lat, lng]
const CITY_DB = {
  // 中国
  '北京': [39.9042, 116.4074], 'beijing': [39.9042, 116.4074],
  '上海': [31.2304, 121.4737], 'shanghai': [31.2304, 121.4737],
  '广州': [23.1291, 113.2644], 'guangzhou': [23.1291, 113.2644],
  '深圳': [22.5431, 114.0579], 'shenzhen': [22.5431, 114.0579],
  '成都': [30.5728, 104.0668], 'chengdu': [30.5728, 104.0668],
  '杭州': [30.2741, 120.1551], 'hangzhou': [30.2741, 120.1551],
  '武汉': [30.5928, 114.3055], 'wuhan': [30.5928, 114.3055],
  '西安': [34.3416, 108.9398], "xi'an": [34.3416, 108.9398], 'xian': [34.3416, 108.9398],
  '南京': [32.0603, 118.7969], 'nanjing': [32.0603, 118.7969],
  '重庆': [29.5630, 106.5516], 'chongqing': [29.5630, 106.5516],
  '天津': [39.3434, 117.3616], 'tianjin': [39.3434, 117.3616],
  '苏州': [31.2989, 120.5853], 'suzhou': [31.2989, 120.5853],
  '郑州': [34.7466, 113.6253], 'zhengzhou': [34.7466, 113.6253],
  '长沙': [28.2278, 112.9388], 'changsha': [28.2278, 112.9388],
  '青岛': [36.0671, 120.3826], 'qingdao': [36.0671, 120.3826],
  '沈阳': [41.8057, 123.4315], 'shenyang': [41.8057, 123.4315],
  '哈尔滨': [45.8038, 126.5349], 'harbin': [45.8038, 126.5349],
  '昆明': [25.0453, 102.7097], 'kunming': [25.0453, 102.7097],
  '乌鲁木齐': [43.8256, 87.6168], 'urumqi': [43.8256, 87.6168],
  '拉萨': [29.6520, 91.1721], 'lhasa': [29.6520, 91.1721],
  '香港': [22.3193, 114.1694], 'hong kong': [22.3193, 114.1694], 'hongkong': [22.3193, 114.1694],
  '台北': [25.0330, 121.5654], 'taipei': [25.0330, 121.5654],
  '澳门': [22.1987, 113.5439], 'macao': [22.1987, 113.5439], 'macau': [22.1987, 113.5439],
  '厦门': [24.4798, 118.0894], 'xiamen': [24.4798, 118.0894],
  '福州': [26.0745, 119.2965], 'fuzhou': [26.0745, 119.2965],
  '济南': [36.6512, 117.1201], 'jinan': [36.6512, 117.1201],
  '合肥': [31.8206, 117.2272], 'hefei': [31.8206, 117.2272],
  '南昌': [28.6820, 115.8579], 'nanchang': [28.6820, 115.8579],
  '贵阳': [26.6470, 106.6302], 'guiyang': [26.6470, 106.6302],
  '南宁': [22.8170, 108.3665], 'nanning': [22.8170, 108.3665],
  '海口': [20.0440, 110.1999], 'haikou': [20.0440, 110.1999],
  '兰州': [36.0611, 103.8343], 'lanzhou': [36.0611, 103.8343],
  '银川': [38.4872, 106.2309], 'yinchuan': [38.4872, 106.2309],
  '西宁': [36.6171, 101.7782], 'xining': [36.6171, 101.7782],
  '呼和浩特': [40.8426, 111.7490], 'hohhot': [40.8426, 111.7490],
  '长春': [43.8171, 125.3235], 'changchun': [43.8171, 125.3235],
  // 亚洲
  '东京': [35.6762, 139.6503], 'tokyo': [35.6762, 139.6503],
  '大阪': [34.6937, 135.5023], 'osaka': [34.6937, 135.5023],
  '京都': [35.0116, 135.7681], 'kyoto': [35.0116, 135.7681],
  '首尔': [37.5665, 126.9780], 'seoul': [37.5665, 126.9780],
  '釜山': [35.1796, 129.0756], 'busan': [35.1796, 129.0756],
  '新加坡': [1.3521, 103.8198], 'singapore': [1.3521, 103.8198],
  '曼谷': [13.7563, 100.5018], 'bangkok': [13.7563, 100.5018],
  '吉隆坡': [3.1390, 101.6869], 'kuala lumpur': [3.1390, 101.6869], 'kl': [3.1390, 101.6869],
  '雅加达': [-6.2088, 106.8456], 'jakarta': [-6.2088, 106.8456],
  '马尼拉': [14.5995, 120.9842], 'manila': [14.5995, 120.9842],
  '河内': [21.0285, 105.8542], 'hanoi': [21.0285, 105.8542],
  '胡志明市': [10.8231, 106.6297], 'ho chi minh': [10.8231, 106.6297], 'saigon': [10.8231, 106.6297],
  '仰光': [16.8661, 96.1951], 'yangon': [16.8661, 96.1951],
  '金边': [11.5564, 104.9282], 'phnom penh': [11.5564, 104.9282],
  '万象': [17.9757, 102.6331], 'vientiane': [17.9757, 102.6331],
  '孟买': [19.0760, 72.8777], 'mumbai': [19.0760, 72.8777], 'bombay': [19.0760, 72.8777],
  '新德里': [28.6139, 77.2090], 'new delhi': [28.6139, 77.2090], 'delhi': [28.6139, 77.2090],
  '班加罗尔': [12.9716, 77.5946], 'bangalore': [12.9716, 77.5946], 'bengaluru': [12.9716, 77.5946],
  '卡拉奇': [24.8607, 67.0011], 'karachi': [24.8607, 67.0011],
  '达卡': [23.8103, 90.4125], 'dhaka': [23.8103, 90.4125],
  '科伦坡': [6.9271, 79.8612], 'colombo': [6.9271, 79.8612],
  '加德满都': [27.7172, 85.3240], 'kathmandu': [27.7172, 85.3240],
  '迪拜': [25.2048, 55.2708], 'dubai': [25.2048, 55.2708],
  '阿布扎比': [24.4539, 54.3773], 'abu dhabi': [24.4539, 54.3773],
  '利雅得': [24.7136, 46.6753], 'riyadh': [24.7136, 46.6753],
  '德黑兰': [35.6892, 51.3890], 'tehran': [35.6892, 51.3890],
  '伊斯坦布尔': [41.0082, 28.9784], 'istanbul': [41.0082, 28.9784],
  '安卡拉': [39.9334, 32.8597], 'ankara': [39.9334, 32.8597],
  '特拉维夫': [32.0853, 34.7818], 'tel aviv': [32.0853, 34.7818],
  '耶路撒冷': [31.7683, 35.2137], 'jerusalem': [31.7683, 35.2137],
  '巴格达': [33.3152, 44.3661], 'baghdad': [33.3152, 44.3661],
  '科威特城': [29.3759, 47.9774], 'kuwait city': [29.3759, 47.9774],
  '多哈': [25.2854, 51.5310], 'doha': [25.2854, 51.5310],
  '马斯喀特': [23.5880, 58.3829], 'muscat': [23.5880, 58.3829],
  '塔什干': [41.2995, 69.2401], 'tashkent': [41.2995, 69.2401],
  '阿拉木图': [43.2220, 76.8512], 'almaty': [43.2220, 76.8512],
  // 欧洲
  '伦敦': [51.5074, -0.1278], 'london': [51.5074, -0.1278],
  '巴黎': [48.8566, 2.3522], 'paris': [48.8566, 2.3522],
  '柏林': [52.5200, 13.4050], 'berlin': [52.5200, 13.4050],
  '马德里': [40.4168, -3.7038], 'madrid': [40.4168, -3.7038],
  '巴塞罗那': [41.3851, 2.1734], 'barcelona': [41.3851, 2.1734],
  '罗马': [41.9028, 12.4964], 'rome': [41.9028, 12.4964],
  '米兰': [45.4654, 9.1859], 'milan': [45.4654, 9.1859],
  '阿姆斯特丹': [52.3676, 4.9041], 'amsterdam': [52.3676, 4.9041],
  '布鲁塞尔': [50.8503, 4.3517], 'brussels': [50.8503, 4.3517],
  '维也纳': [48.2082, 16.3738], 'vienna': [48.2082, 16.3738],
  '苏黎世': [47.3769, 8.5417], 'zurich': [47.3769, 8.5417],
  '日内瓦': [46.2044, 6.1432], 'geneva': [46.2044, 6.1432],
  '斯德哥尔摩': [59.3293, 18.0686], 'stockholm': [59.3293, 18.0686],
  '奥斯陆': [59.9139, 10.7522], 'oslo': [59.9139, 10.7522],
  '哥本哈根': [55.6761, 12.5683], 'copenhagen': [55.6761, 12.5683],
  '赫尔辛基': [60.1699, 24.9384], 'helsinki': [60.1699, 24.9384],
  '莫斯科': [55.7558, 37.6173], 'moscow': [55.7558, 37.6173],
  '圣彼得堡': [59.9311, 30.3609], 'saint petersburg': [59.9311, 30.3609], 'st petersburg': [59.9311, 30.3609],
  '华沙': [52.2297, 21.0122], 'warsaw': [52.2297, 21.0122],
  '布拉格': [50.0755, 14.4378], 'prague': [50.0755, 14.4378],
  '布达佩斯': [47.4979, 19.0402], 'budapest': [47.4979, 19.0402],
  '雅典': [37.9838, 23.7275], 'athens': [37.9838, 23.7275],
  '里斯本': [38.7223, -9.1393], 'lisbon': [38.7223, -9.1393],
  '都柏林': [53.3498, -6.2603], 'dublin': [53.3498, -6.2603],
  '爱丁堡': [55.9533, -3.1883], 'edinburgh': [55.9533, -3.1883],
  '曼彻斯特': [53.4808, -2.2426], 'manchester': [53.4808, -2.2426],
  '法兰克福': [50.1109, 8.6821], 'frankfurt': [50.1109, 8.6821],
  '慕尼黑': [48.1351, 11.5820], 'munich': [48.1351, 11.5820],
  '汉堡': [53.5753, 10.0153], 'hamburg': [53.5753, 10.0153],
  '基辅': [50.4501, 30.5234], 'kyiv': [50.4501, 30.5234], 'kiev': [50.4501, 30.5234],
  '明斯克': [53.9045, 27.5615], 'minsk': [53.9045, 27.5615],
  '布加勒斯特': [44.4268, 26.1025], 'bucharest': [44.4268, 26.1025],
  '索菲亚': [42.6977, 23.3219], 'sofia': [42.6977, 23.3219],
  '贝尔格莱德': [44.7866, 20.4489], 'belgrade': [44.7866, 20.4489],
  '萨格勒布': [45.8150, 15.9819], 'zagreb': [45.8150, 15.9819],
  '卢布尔雅那': [46.0569, 14.5058], 'ljubljana': [46.0569, 14.5058],
  '塔林': [59.4370, 24.7536], 'tallinn': [59.4370, 24.7536],
  '里加': [56.9496, 24.1052], 'riga': [56.9496, 24.1052],
  '维尔纽斯': [54.6872, 25.2797], 'vilnius': [54.6872, 25.2797],
  // 美洲
  '纽约': [40.7128, -74.0060], 'new york': [40.7128, -74.0060], 'nyc': [40.7128, -74.0060],
  '洛杉矶': [34.0522, -118.2437], 'los angeles': [34.0522, -118.2437], 'la': [34.0522, -118.2437],
  '芝加哥': [41.8781, -87.6298], 'chicago': [41.8781, -87.6298],
  '旧金山': [37.7749, -122.4194], 'san francisco': [37.7749, -122.4194], 'sf': [37.7749, -122.4194],
  '西雅图': [47.6062, -122.3321], 'seattle': [47.6062, -122.3321],
  '波士顿': [42.3601, -71.0589], 'boston': [42.3601, -71.0589],
  '华盛顿': [38.9072, -77.0369], 'washington': [38.9072, -77.0369], 'washington dc': [38.9072, -77.0369],
  '迈阿密': [25.7617, -80.1918], 'miami': [25.7617, -80.1918],
  '拉斯维加斯': [36.1699, -115.1398], 'las vegas': [36.1699, -115.1398],
  '丹佛': [39.7392, -104.9903], 'denver': [39.7392, -104.9903],
  '休斯顿': [29.7604, -95.3698], 'houston': [29.7604, -95.3698],
  '达拉斯': [32.7767, -96.7970], 'dallas': [32.7767, -96.7970],
  '亚特兰大': [33.7490, -84.3880], 'atlanta': [33.7490, -84.3880],
  '多伦多': [43.6532, -79.3832], 'toronto': [43.6532, -79.3832],
  '温哥华': [49.2827, -123.1207], 'vancouver': [49.2827, -123.1207],
  '蒙特利尔': [45.5017, -73.5673], 'montreal': [45.5017, -73.5673],
  '渥太华': [45.4215, -75.6972], 'ottawa': [45.4215, -75.6972],
  '墨西哥城': [19.4326, -99.1332], 'mexico city': [19.4326, -99.1332],
  '圣保罗': [-23.5505, -46.6333], 'sao paulo': [-23.5505, -46.6333],
  '里约热内卢': [-22.9068, -43.1729], 'rio de janeiro': [-22.9068, -43.1729], 'rio': [-22.9068, -43.1729],
  '巴西利亚': [-15.7942, -47.8822], 'brasilia': [-15.7942, -47.8822],
  '布宜诺斯艾利斯': [-34.6037, -58.3816], 'buenos aires': [-34.6037, -58.3816],
  '波哥大': [4.7110, -74.0721], 'bogota': [4.7110, -74.0721],
  '利马': [-12.0464, -77.0428], 'lima': [-12.0464, -77.0428],
  '圣地亚哥': [-33.4489, -70.6693], 'santiago': [-33.4489, -70.6693],
  '加拉加斯': [10.4806, -66.9036], 'caracas': [10.4806, -66.9036],
  '基多': [-0.1807, -78.4678], 'quito': [-0.1807, -78.4678],
  '哈瓦那': [23.1136, -82.3666], 'havana': [23.1136, -82.3666],
  // 非洲
  '开罗': [30.0444, 31.2357], 'cairo': [30.0444, 31.2357],
  '亚历山大': [31.2001, 29.9187], 'alexandria': [31.2001, 29.9187],
  '卡萨布兰卡': [33.5731, -7.5898], 'casablanca': [33.5731, -7.5898],
  '突尼斯': [36.8190, 10.1658], 'tunis': [36.8190, 10.1658],
  '的黎波里': [32.8872, 13.1913], 'tripoli': [32.8872, 13.1913],
  '拉各斯': [6.5244, 3.3792], 'lagos': [6.5244, 3.3792],
  '阿比让': [5.3600, -4.0083], 'abidjan': [5.3600, -4.0083],
  '达喀尔': [14.7167, -17.4677], 'dakar': [14.7167, -17.4677],
  '亚的斯亚贝巴': [9.0320, 38.7469], 'addis ababa': [9.0320, 38.7469],
  '内罗毕': [-1.2921, 36.8219], 'nairobi': [-1.2921, 36.8219],
  '达累斯萨拉姆': [-6.7924, 39.2083], 'dar es salaam': [-6.7924, 39.2083],
  '约翰内斯堡': [-26.2041, 28.0473], 'johannesburg': [-26.2041, 28.0473],
  '开普敦': [-33.9249, 18.4241], 'cape town': [-33.9249, 18.4241],
  '德班': [-29.8587, 31.0218], 'durban': [-29.8587, 31.0218],
  '哈拉雷': [-17.8252, 31.0335], 'harare': [-17.8252, 31.0335],
  '卢萨卡': [-15.4167, 28.2833], 'lusaka': [-15.4167, 28.2833],
  '安哥拉': [-8.8368, 13.2343], 'luanda': [-8.8368, 13.2343],
  // 大洋洲
  '悉尼': [-33.8688, 151.2093], 'sydney': [-33.8688, 151.2093],
  '墨尔本': [-37.8136, 144.9631], 'melbourne': [-37.8136, 144.9631],
  '布里斯班': [-27.4698, 153.0251], 'brisbane': [-27.4698, 153.0251],
  '珀斯': [-31.9505, 115.8605], 'perth': [-31.9505, 115.8605],
  '阿德莱德': [-34.9285, 138.6007], 'adelaide': [-34.9285, 138.6007],
  '堪培拉': [-35.2809, 149.1300], 'canberra': [-35.2809, 149.1300],
  '奥克兰': [-36.8485, 174.7633], 'auckland': [-36.8485, 174.7633],
  '惠灵顿': [-41.2866, 174.7756], 'wellington': [-41.2866, 174.7756],
  '苏瓦': [-18.1416, 178.4419], 'suva': [-18.1416, 178.4419],
};

/**
 * 将 Nominatim address 对象格式化为 "国 · 省 · 市 · 区 · 街道"
 */
function formatAddress(addr) {
  const parts = [
    addr.country,
    addr.state !== addr.city ? addr.state : null,
    addr.city || addr.town || addr.village || addr.municipality,
    addr.city_district || addr.district || addr.county,
    addr.suburb || addr.neighbourhood || addr.quarter,
    addr.road,
  ];
  return parts.filter(Boolean).join(' · ');
}

/**
 * 查询城市经纬度
 * 1. 先调 Nominatim（addressdetails=1），返回完整层级地址
 * 2. 网络不可用时回退到内置表
 * @returns {{ lat, lng, displayName } | null}
 */
export async function lookupCity(name) {
  try {
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(name)}&format=json&limit=1&addressdetails=1`;
    const resp = await fetch(url, { headers: { 'Accept-Language': 'zh-CN,zh,en' } });
    const data = await resp.json();
    if (data.length > 0) {
      const item = data[0];
      const displayName = formatAddress(item.address || {}) || item.display_name.split(',')[0].trim();
      return { lat: parseFloat(item.lat), lng: parseFloat(item.lon), displayName };
    }
  } catch { /* 网络不可用，回退内置表 */ }

  // 回退：内置表
  const key = name.trim().toLowerCase();
  const entry = CITY_DB[key] || CITY_DB[name.trim()];
  if (entry) {
    const [lat, lng] = entry;
    return { lat, lng, displayName: name.trim() };
  }
  return null;
}

/**
 * 反向地理编码：经纬度 → "国 · 省 · 市 · 区 · 街道"
 * @returns {string | null}
 */
export async function reverseGeocode(lat, lng) {
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`;
    const resp = await fetch(url, { headers: { 'Accept-Language': 'zh-CN,zh,en' } });
    const data = await resp.json();
    if (data?.address) return formatAddress(data.address) || null;
  } catch {}
  return null;
}
